name: Send UX Metrics to Grafana

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  export-ux-metrics:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run UX Metrics collector (headless)
        env:
          FRONT_URL: "https://tukuntech-front.netlify.app"
          E2E_USER: ${{ secrets.E2E_USER }}
          E2E_PASS: ${{ secrets.E2E_PASS }}
        run: |
          set -euo pipefail
          mkdir -p metrics
          npm i playwright@1.48.2
          npx playwright install chromium

          cat > collect_ux_metrics.mjs <<'JS'
          import { chromium } from 'playwright';
          import fs from 'node:fs';

          const FRONT_URL = process.env.FRONT_URL;
          const USER = process.env.E2E_USER;
          const PASS = process.env.E2E_PASS;

          if (!FRONT_URL || !USER || !PASS) {
            console.error("‚ùå Missing FRONT_URL, E2E_USER or E2E_PASS env vars");
            process.exit(1);
          }

          let browser;

          try {
            browser = await chromium.launch({ headless: true });
            const page = await browser.newPage({ viewport: { width: 1366, height: 800 } });

            // Timeouts m√°s generosos para CI
            page.setDefaultNavigationTimeout(60000);
            page.setDefaultTimeout(30000);

            console.log("üåê Opening front:", FRONT_URL);
            await page.goto(`${FRONT_URL}/auth/login`, { waitUntil: 'domcontentloaded', timeout: 60000 });

            await page.fill('input[name="username"], input[formcontrolname="username"]', USER);
            await page.fill('input[name="password"], input[formcontrolname="password"]', PASS);

            await Promise.all([
              page.click('button[type="submit"]'),
              page.waitForURL('**/dashboard/**', { timeout: 60000 }),
            ]);

            console.log("‚úÖ Logged in, navigating through routes...");

            const routes = [
              { path: '/dashboard/patient', selector: 'app-patient-list, [data-ux="patient-list"]' },
              { path: '/vital-signs',       selector: 'app-vital-signs, [data-ux="vital-signs"]' },
              { path: '/history',           selector: 'app-history, [data-ux="history"]' },
              { path: '/support',           selector: 'app-support, [data-ux="support"]' },
            ];

            for (const { path, selector } of routes) {
              console.log("‚û°Ô∏è", path);
              try {
                await page.goto(`${FRONT_URL}${path}`, {
                  waitUntil: 'domcontentloaded',
                  timeout: 60000,
                });

                if (selector) {
                  await page.waitForSelector(selector, { timeout: 15000 })
                    .catch(() => console.warn(`‚ö†Ô∏è No se encontr√≥ selector "${selector}" en ${path}, contin√∫o...`));
                }

                // Peque√±a espera para que se generen eventos UX
                await page.waitForTimeout(1000);
              } catch (err) {
                console.warn(`‚ö†Ô∏è Error navegando a ${path}:`, err.message ?? err);
                // No hacemos throw aqu√≠ para no romper todo el flujo.
              }
            }

            // Extrae la cola UX
            const data = await page.evaluate(() => {
              // En caso de que la app no defina __UXQ
              return (window.__UXQ && Array.isArray(window.__UXQ)) ? window.__UXQ : [];
            });

            fs.writeFileSync('metrics/frontend_ux.json', JSON.stringify(data, null, 2));
            console.log(`‚úÖ Collected ${data.length} UX events.`);

          } catch (err) {
            console.error("‚ùå UX metrics collection failed:", err);
            process.exitCode = 1;
          } finally {
            if (browser) {
              await browser.close();
            }
          }
          JS

          node collect_ux_metrics.mjs

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install OTLP exporter
        run: |
          pip install \
            opentelemetry-sdk==1.38.0 \
            opentelemetry-api==1.38.0 \
            opentelemetry-exporter-otlp==1.38.0

      - name: Send UX metrics to Grafana Cloud
        env:
          OTLP_ENDPOINT: ${{ secrets.GRAFANA_OTLP_ENDPOINT }}
          GRAFANA_ID: ${{ secrets.GRAFANA_INSTANCE_ID }}
          GRAFANA_TOKEN: ${{ secrets.GRAFANA_API_TOKEN }}
        run: |
          python - << 'PY'
          import os, json, time, base64
          from opentelemetry.sdk.resources import Resource
          from opentelemetry.sdk.metrics import MeterProvider
          from opentelemetry.sdk.metrics.export import PeriodicExportingMetricReader
          from opentelemetry.exporter.otlp.proto.http.metric_exporter import OTLPMetricExporter

          endpoint = os.environ["OTLP_ENDPOINT"].rstrip("/") + "/v1/metrics"
          uid = os.environ["GRAFANA_ID"]
          token = os.environ["GRAFANA_TOKEN"]
          basic = base64.b64encode(f"{uid}:{token}".encode("ascii")).decode("ascii")

          exporter = OTLPMetricExporter(
              endpoint=endpoint,
              headers=(("Authorization", f"Basic {basic}"),),
          )

          resource = Resource.create({
              "service.name": "frontend-ux",
              "service.namespace": "ci"
          })

          reader = PeriodicExportingMetricReader(exporter, export_interval_millis=1000)
          provider = MeterProvider(resource=resource, metric_readers=[reader])
          meter = provider.get_meter("ux-metrics")

          hist = meter.create_histogram("frontend_ux_ms")

          with open("metrics/frontend_ux.json", "r", encoding="utf-8") as f:
              items = json.load(f)

          count = 0
          for e in items:
              dur = float(e.get("value", 0))
              attrs = {
                  "metric": e.get("metric"),
                  "route": e.get("route", ""),
              }
              hist.record(dur, attributes=attrs)
              count += 1

          time.sleep(3)
          print(f"‚úÖ Sent {count} UX events to Grafana.")
          PY

      - name: Upload artifact (for debug)
        uses: actions/upload-artifact@v4
        with:
          name: frontend_ux
          path: metrics/frontend_ux.json
