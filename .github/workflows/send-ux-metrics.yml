name: Send UX Metrics to Grafana

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  export-ux-metrics:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run UX Metrics collector (headless)
        env:
          FRONT_URL: "https://tukuntech-front.netlify.app"
          E2E_USER: ${{ secrets.E2E_USER }}
          E2E_PASS: ${{ secrets.E2E_PASS }}
        run: |
          set -euo pipefail
          mkdir -p metrics
          npm i playwright@1.48.2
          npx playwright install chromium

          cat > collect_ux_metrics.mjs <<'JS'
          import { chromium } from 'playwright';
          import fs from 'node:fs';

          const FRONT_URL = process.env.FRONT_URL;
          const USER = process.env.E2E_USER;
          const PASS = process.env.E2E_PASS;

          const METRICS_PATH = 'metrics/frontend_ux.json';

          async function main() {
            let browser;
            const collected = [];

            // Helper para escribir siempre el archivo, aunque est√© vac√≠o
            const writeMetricsFile = () => {
              try {
                fs.writeFileSync(METRICS_PATH, JSON.stringify(collected, null, 2));
                console.log(`‚úÖ UX metrics file written with ${collected.length} events (best-effort).`);
              } catch (err) {
                console.error("‚ùå Failed to write UX metrics file:", err);
              }
            };

            // Validaci√≥n suave de env vars
            if (!FRONT_URL || !USER || !PASS) {
              console.warn("‚ö†Ô∏è FRONT_URL, E2E_USER or E2E_PASS not set. Skipping UX navigation, writing empty metrics.");
              writeMetricsFile();
              return;
            }

            try {
              browser = await chromium.launch({ headless: true });
              const page = await browser.newPage({ viewport: { width: 1366, height: 800 } });

              page.setDefaultNavigationTimeout(60000);
              page.setDefaultTimeout(30000);

              console.log("üåê Opening front:", FRONT_URL);
              await page.goto(`${FRONT_URL}/auth/login`, {
                waitUntil: 'domcontentloaded',
                timeout: 60000,
              });

              await page.fill('input[name="username"], input[formcontrolname="username"]', USER);
              await page.fill('input[name="password"], input[formcontrolname="password"]', PASS);

              await Promise.all([
                page.click('button[type="submit"]'),
                page.waitForURL('**/dashboard/**', { timeout: 60000 }),
              ]);

              console.log("‚úÖ Logged in, navigating through routes...");

              const routes = [
                { path: '/dashboard/patient', selector: null },
                { path: '/vital-signs',       selector: null },
                { path: '/history',           selector: null },
                { path: '/support',           selector: null },
              ];

              for (const { path, selector } of routes) {
                console.log("‚û°Ô∏è", path);

                let success = false;
                for (let attempt = 1; attempt <= 2; attempt++) {
                  try {
                    console.log(`   ‚Ü≥ attempt ${attempt}`);
                    await page.goto(`${FRONT_URL}${path}`, {
                      waitUntil: 'domcontentloaded',
                      timeout: 60000,
                    });

                    if (selector) {
                      await page
                        .waitForSelector(selector, { timeout: 15000 })
                        .catch(() => {
                          console.warn(`‚ö†Ô∏è Selector "${selector}" not found on ${path}, continuing...`);
                        });
                    }

                    // Espera un poco para que la app pueda disparar eventos UX
                    await page.waitForTimeout(2000);
                    success = true;
                    break;
                  } catch (err) {
                    console.warn(`‚ö†Ô∏è Error navigating to ${path} (attempt ${attempt}):`, err.message ?? err);
                  }
                }

                if (!success) {
                  console.warn(`‚ö†Ô∏è Giving up on ${path} after multiple attempts (non-blocking).`);
                }
              }

              // Extrae la cola UX
              try {
                const data = await page.evaluate(() => {
                  const q = window.__UXQ;
                  if (!q || !Array.isArray(q)) {
                    return [];
                  }
                  return q;
                });

                collected.push(...data);
              } catch (err) {
                console.warn("‚ö†Ô∏è Failed to read window.__UXQ, using empty list:", err.message ?? err);
              }

            } catch (err) {
              console.error("‚ö†Ô∏è UX metrics collection encountered an error (non-blocking):", err);
              // No lanzamos error; el flujo es best-effort
            } finally {
              // Siempre escribimos el archivo, aunque sea vac√≠o
              writeMetricsFile();

              if (browser) {
                try {
                  await browser.close();
                } catch (err) {
                  console.warn("‚ö†Ô∏è Error closing browser:", err.message ?? err);
                }
              }
            }
          }

          // Ejecutar y asegurar que cualquier rechazo no reviente el proceso
          main().catch(err => {
            console.error("‚ö†Ô∏è Unhandled error in main (non-blocking):", err);
          });
          JS

          # Aunque node fallara por alguna raz√≥n, no queremos romper el job:
          node collect_ux_metrics.mjs || echo "‚ö†Ô∏è UX metrics script failed but this is non-blocking."

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install OTLP exporter
        run: |
          set -euo pipefail
          pip install \
            opentelemetry-sdk==1.38.0 \
            opentelemetry-api==1.38.0 \
            opentelemetry-exporter-otlp==1.38.0

      - name: Send UX metrics to Grafana Cloud (best-effort)
        env:
          OTLP_ENDPOINT: ${{ secrets.GRAFANA_OTLP_ENDPOINT }}
          GRAFANA_ID: ${{ secrets.GRAFANA_INSTANCE_ID }}
          GRAFANA_TOKEN: ${{ secrets.GRAFANA_API_TOKEN }}
        run: |
          set -euo pipefail
          python - << 'PY'
          import os, json, time, base64, pathlib, sys

          metrics_path = pathlib.Path("metrics/frontend_ux.json")

          if not metrics_path.exists():
            print("‚ö†Ô∏è UX metrics file not found, skipping export (non-blocking).")
            sys.exit(0)

          try:
            raw = metrics_path.read_text(encoding="utf-8")
            items = json.loads(raw or "[]")
          except Exception as e:
            print(f"‚ö†Ô∏è Could not parse UX metrics JSON: {e}. Skipping export (non-blocking).")
            sys.exit(0)

          if not isinstance(items, list) or not items:
            print("‚ÑπÔ∏è UX metrics list is empty or invalid, nothing to export.")
            sys.exit(0)

          otlp_endpoint = os.environ.get("OTLP_ENDPOINT", "").strip()
          grafana_id = os.environ.get("GRAFANA_ID", "").strip()
          grafana_token = os.environ.get("GRAFANA_TOKEN", "").strip()

          if not otlp_endpoint or not grafana_id or not grafana_token:
            print("‚ö†Ô∏è OTLP/Grafana configuration missing. Skipping export (non-blocking).")
            sys.exit(0)

          try:
            from opentelemetry.sdk.resources import Resource
            from opentelemetry.sdk.metrics import MeterProvider
            from opentelemetry.sdk.metrics.export import PeriodicExportingMetricReader
            from opentelemetry.exporter.otlp.proto.http.metric_exporter import OTLPMetricExporter
          except Exception as e:
            print(f"‚ö†Ô∏è Failed to import OpenTelemetry libraries: {e}. Skipping export (non-blocking).")
            sys.exit(0)

          try:
            endpoint = otlp_endpoint.rstrip("/") + "/v1/metrics"
            basic = base64.b64encode(f"{grafana_id}:{grafana_token}".encode("ascii")).decode("ascii")

            exporter = OTLPMetricExporter(
                endpoint=endpoint,
                headers=(("Authorization", f"Basic {basic}"),),
            )

            resource = Resource.create({
                "service.name": "frontend-ux",
                "service.namespace": "ci"
            })

            reader = PeriodicExportingMetricReader(exporter, export_interval_millis=1000)
            provider = MeterProvider(resource=resource, metric_readers=[reader])
            meter = provider.get_meter("ux-metrics")

            hist = meter.create_histogram("frontend_ux_ms")

            count = 0
            for e in items:
                try:
                    dur = float(e.get("value", 0) or 0)
                except Exception:
                    dur = 0.0

                attrs = {
                    "metric": e.get("metric") or "",
                    "route": e.get("route") or "",
                }
                try:
                    hist.record(dur, attributes=attrs)
                    count += 1
                except Exception as rec_err:
                    print(f"‚ö†Ô∏è Failed to record UX metric {e}: {rec_err}")

            # Dar tiempo al reader para exportar
            time.sleep(3)
            print(f"‚úÖ Best-effort: sent {count} UX events to Grafana.")
          except Exception as e:
            print(f"‚ö†Ô∏è Failed sending UX metrics to Grafana (non-blocking): {e}")
            # No hacemos sys.exit(1) para no romper el job
            sys.exit(0)
          PY

      - name: Upload artifact (for debug)
        uses: actions/upload-artifact@v4
        with:
          name: frontend_ux
          path: metrics/frontend_ux.json
